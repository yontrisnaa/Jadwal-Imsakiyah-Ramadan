<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jadwal Imsakiyah Ramadan</title>
    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Colors */
            --primary: #0f766e;
            --primary-light: #14b8a6;
            --primary-dark: #0f5132;
            --secondary: #f59e0b;

            /* Backgrounds */
            --bg-body: #f8fafc;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.85);
            /* Dark Mode */
            --dark-bg-body: #0f172a;
            --dark-bg-card: #1e293b;
            --dark-bg-glass: rgba(30, 41, 59, 0.85);

            /* Text */
            --text-main: #0f172a;
            --text-muted: #64748b;
            --dark-text-main: #f8fafc;
            --dark-text-muted: #94a3b8;

            --border-light: #e2e8f0;
            --border-dark: #334155;

            /* Shadows & Transitions */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-glow: 0 0 15px rgba(20, 184, 166, 0.4);

            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

            /* Radius */
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            transition: var(--transition);
        }

        body.dark-mode {
            background-color: var(--dark-bg-body);
            color: var(--dark-text-main);
        }

        /* --- Header / Hero Pattern --- */
        .hero {
            position: relative;
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            padding: 4rem 1rem 6rem;
            text-align: center;
            color: white;
            overflow: hidden;
            border-bottom-left-radius: 40px;
            border-bottom-right-radius: 40px;
        }

        /* Islamic Geometric Pattern Overlay */
        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.08'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.6;
            z-index: 1;
        }

        .hero-content {
            position: relative;
            z-index: 2;
            max-width: 800px;
            margin: 0 auto;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .hero h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .hero p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-family: 'Inter', sans-serif;
            max-width: 500px;
            margin: 0 auto;
        }

        /* Modern Header Nav */
        nav {
            position: absolute;
            top: 1rem;
            right: 2rem;
            z-index: 10;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(8px);
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(15deg) scale(1.05);
        }

        /* --- Main Content --- */
        main {
            flex: 1;
            max-width: 1000px;
            width: 90%;
            margin: -4rem auto 3rem;
            position: relative;
            z-index: 5;
        }

        /* --- Search Card (Glassmorphism) --- */
        .search-card {
            background: var(--bg-glass);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            margin-bottom: 3rem;
            transition: var(--transition);
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        body.dark-mode .search-card {
            background: var(--dark-bg-glass);
            border-color: var(--border-dark);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 1.5rem;
            align-items: end;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
        }

        body.dark-mode .input-group label {
            color: var(--dark-text-muted);
        }

        .select-wrapper {
            position: relative;
        }

        .select-wrapper i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--primary);
            pointer-events: none;
        }

        select {
            width: 100%;
            padding: 1rem 1rem 1rem 2.8rem;
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            font-weight: 500;
            color: var(--text-main);
            background-color: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            appearance: none;
            cursor: pointer;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode select {
            background-color: var(--dark-bg-card);
            color: var(--dark-text-main);
            border-color: var(--border-dark);
        }

        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.2);
        }

        /* Custom Select Arrow */
        .select-wrapper::after {
            content: '\f107';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 1.2rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
            transition: transform 0.3s ease;
        }

        select:focus+.select-wrapper::after {
            transform: translateY(-50%) rotate(180deg);
        }

        button.btn-search {
            background: var(--primary);
            color: white;
            border: none;
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            font-family: 'Outfit', sans-serif;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            height: 52px;
            box-shadow: var(--shadow-md);
        }

        button.btn-search:hover {
            background: var(--primary-dark);
            box-shadow: var(--shadow-glow);
            transform: translateY(-2px);
        }

        button.btn-search i {
            transition: transform 0.3s ease;
        }

        button.btn-search:hover i {
            transform: scale(1.1) rotate(10deg);
        }

        button:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        /* --- Loading State --- */
        .loader-container {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 3rem 0;
            gap: 1rem;
        }

        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(20, 184, 166, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* --- Results Area --- */
        .results-header {
            display: none;
            text-align: center;
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-out;
        }

        .results-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .results-header p {
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
        }

        body.dark-mode .results-header p {
            color: var(--dark-text-muted);
        }

        /* Schedule Grid Layout */
        .schedule-grid {
            display: none;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* --- Day Card (Beautiful & Dynamic) --- */
        .day-card {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
            overflow: hidden;
            transition: var(--transition);
            position: relative;
            animation: slideUpFade 0.5s ease-out backwards;
        }

        body.dark-mode .day-card {
            background: var(--dark-bg-card);
            border-color: var(--border-dark);
        }

        /* Define delays for grid items incrementally via JS, or just use CSS classes */
        @keyframes slideUpFade {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .day-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: var(--primary-light);
        }

        /* Today Highlight Card */
        .day-card.today {
            border: 2px solid var(--secondary);
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.2);
            z-index: 2;
        }

        .day-card.today:hover {
            transform: scale(1.02) translateY(-5px);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
        }

        .card-header {
            background: rgba(15, 118, 110, 0.05);
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        body.dark-mode .card-header {
            background: rgba(15, 118, 110, 0.15);
            border-color: var(--border-dark);
        }

        .day-card.today .card-header {
            background: var(--secondary);
            color: white;
            border-bottom: none;
        }

        .date-number {
            font-size: 1.2rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .day-card:not(.today) .date-number {
            color: var(--primary-dark);
        }

        body.dark-mode .day-card:not(.today) .date-number {
            color: var(--primary-light);
        }

        .badge-today {
            background: white;
            color: var(--secondary);
            font-size: 0.7rem;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* The Timetable inside Card */
        .times-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            padding: 0.5rem;
        }

        .time-slot {
            padding: 0.8rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
        }

        body.dark-mode .time-slot {
            border-color: var(--border-dark);
        }

        /* Remove bottom border on last two items */
        .time-slot:nth-last-child(1),
        .time-slot:nth-last-child(2) {
            border-bottom: none;
        }

        /* Vertical separator */
        .time-slot:nth-child(odd) {
            border-right: 1px solid var(--border-light);
        }

        body.dark-mode .time-slot:nth-child(odd) {
            border-color: var(--border-dark);
        }

        .time-slot:hover {
            background-color: rgba(15, 118, 110, 0.05);
        }

        body.dark-mode .time-slot:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        /* Highlight specific times */
        .time-slot.highlight {
            background-color: rgba(15, 118, 110, 0.08);
        }

        body.dark-mode .time-slot.highlight {
            background-color: rgba(20, 184, 166, 0.15);
        }

        .time-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--bg-body);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 0.9rem;
            box-shadow: var(--shadow-sm);
        }

        body.dark-mode .time-icon {
            background: var(--dark-bg-body);
            color: var(--primary-light);
        }

        .time-info {
            display: flex;
            flex-direction: column;
        }

        .time-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-family: 'Inter', sans-serif;
            font-weight: 600;
        }

        body.dark-mode .time-label {
            color: var(--dark-text-muted);
        }

        .time-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        body.dark-mode .time-value {
            color: var(--dark-text-main);
        }

        .time-slot.highlight .time-value {
            color: var(--primary-dark);
        }

        body.dark-mode .time-slot.highlight .time-value {
            color: var(--primary-light);
        }

        /* Error state */
        .error-msg {
            display: none;
            background: #fee2e2;
            color: #b91c1c;
            padding: 1rem;
            border-radius: var(--radius-md);
            border-left: 4px solid #ef4444;
            margin-bottom: 2rem;
            text-align: left;
            font-family: 'Inter', sans-serif;
        }

        body.dark-mode .error-msg {
            background: rgba(185, 28, 28, 0.1);
            color: #fca5a5;
        }

        footer {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
            font-size: 0.9rem;
            font-family: 'Inter', sans-serif;
            margin-top: auto;
        }

        body.dark-mode footer {
            color: var(--dark-text-muted);
        }
    </style>
</head>

<body>

    <header class="hero">
        <nav>
            <button class="theme-toggle" id="themeBtn" aria-label="Toggle dark mode">
                <i class="fas fa-moon"></i>
            </button>
        </nav>
        <div class="hero-content">
            <h1 id="pageTitle">Jadwal Imsakiyah Ramadan</h1>
            <p id="pageDesc">Jadwal resmi dari Bimas Islam Kementerian Agama Republik Indonesia.</p>
        </div>
    </header>

    <main>
        <div class="search-card">
            <div id="errorMsg" class="error-msg"></div>

            <div class="form-grid">
                <!-- Mode Toggle -->
                <div class="input-group">
                    <label for="mode">Pilih Mode Jadwal</label>
                    <div class="select-wrapper">
                        <i class="fas fa-calendar-alt"></i>
                        <select id="mode">
                            <option value="imsakiyah" selected>Jadwal Imsakiyah (1 Bulan Ramadan)</option>
                            <option value="shalat">Jadwal Shalat (Bulan Masehi)</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label for="provinsi">Pilih Provinsi</label>
                    <div class="select-wrapper">
                        <i class="fas fa-map-marker-alt"></i>
                        <select id="provinsi">
                            <option value="" disabled selected>Memuat Provinsi...</option>
                        </select>
                    </div>
                </div>

                <div class="input-group">
                    <label for="kota">Pilih Kab/Kota</label>
                    <div class="select-wrapper">
                        <i class="fas fa-city"></i>
                        <select id="kota" disabled>
                            <option value="" disabled selected>Pilih Provinsi Terlebih Dahulu</option>
                        </select>
                    </div>
                </div>

                <div class="input-group" id="monthSelector" style="display: none;">
                    <label for="bulan">Pilih Bulan</label>
                    <div class="select-wrapper">
                        <i class="fas fa-calendar-day"></i>
                        <select id="bulan">
                            <option value="1">Januari</option>
                            <option value="2">Februari</option>
                            <option value="3">Maret</option>
                            <option value="4">April</option>
                            <option value="5">Mei</option>
                            <option value="6">Juni</option>
                            <option value="7">Juli</option>
                            <option value="8">Agustus</option>
                            <option value="9">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                </div>

                <div class="search-actions" style="grid-column: 1 / -1; display: flex; gap: 1rem; flex-wrap: wrap;">
                    <button id="searchBtn" class="btn-search" style="flex: 1;">
                        <i class="fas fa-search"></i> Cari Jadwal
                    </button>
                </div>
            </div>
        </div>

        <div id="loader" class="loader-container">
            <div class="loader"></div>
            <p style="color: var(--text-muted); font-family: 'Inter', sans-serif;">Mengambil data jadwal dari server...
            </p>
        </div>

        <div id="resultsHeader" class="results-header">
            <h2 id="lokasiPrint">Mencari...</h2>
            <p id="tahunPrint">Mohon tunggu sebentar</p>
        </div>

        <div id="scheduleGrid" class="schedule-grid">
            <!-- Cards will be dynamically inserted here -->
        </div>
    </main>

    <footer>
        <p>Data bersumber dari API <strong>Bimas Islam Kemenag RI</strong>.</p>
    </footer>

    <script>
        // Data Provinsi (Hardcoded values needed for API)
        const PROVINCES = [
            { "text": "ACEH", "value": "c4ca4238a0b923820dcc509a6f75849b" },
            { "text": "SUMATERA UTARA", "value": "c81e728d9d4c2f636f067f89cc14862c" },
            { "text": "SUMATERA BARAT", "value": "eccbc87e4b5ce2fe28308fd9f2a7baf3" },
            { "text": "RIAU", "value": "a87ff679a2f3e71d9181a67b7542122c" },
            { "text": "KEPULAUAN RIAU", "value": "e4da3b7fbbce2345d7772b0674a318d5" },
            { "text": "JAMBI", "value": "1679091c5a880faf6fb5e6087eb1b2dc" },
            { "text": "BENGKULU", "value": "8f14e45fceea167a5a36dedd4bea2543" },
            { "text": "SUMATERA SELATAN", "value": "c9f0f895fb98ab9159f51fd0297e236d" },
            { "text": "KEPULAUAN BANGKA BELITUNG", "value": "45c48cce2e2d7fbdea1afc51c7c6ad26" },
            { "text": "LAMPUNG", "value": "d3d9446802a44259755d38e6d163e820" },
            { "text": "BANTEN", "value": "6512bd43d9caa6e02c990b0a82652dca" },
            { "text": "JAWA BARAT", "value": "c20ad4d76fe97759aa27a0c99bff6710" },
            { "text": "DKI JAKARTA", "value": "c51ce410c124a10e0db5e4b97fc2af39" },
            { "text": "JAWA TENGAH", "value": "aab3238922bcc25a6f606eb525ffdc56" },
            { "text": "D.I. YOGYAKARTA", "value": "9bf31c7ff062936a96d3c8bd1f8f2ff3" },
            { "text": "JAWA TIMUR", "value": "c74d97b01eae257e44aa9d5bade97baf" },
            { "text": "BALI", "value": "70efdf2ec9b086079795c442636b55fb" },
            { "text": "NUSA TENGGARA BARAT", "value": "6f4922f45568161a8cdf4ad2299f6d23" },
            { "text": "NUSA TENGGARA TIMUR", "value": "1f0e3dad99908345f7439f8ffabdffc4" },
            { "text": "KALIMANTAN BARAT", "value": "98f13708210194c475687be6106a3b84" },
            { "text": "KALIMANTAN SELATAN", "value": "3c59dc048e8850243be8079a5c74d079" },
            { "text": "KALIMANTAN TENGAH", "value": "b6d767d2f8ed5d21a44b0e5886680cb9" },
            { "text": "KALIMANTAN TIMUR", "value": "37693cfc748049e45d87b8c7d8b9aacd" },
            { "text": "KALIMANTAN UTARA", "value": "1ff1de774005f8da13f42943881c655f" },
            { "text": "GORONTALO", "value": "8e296a067a37563370ded05f5a3bf3ec" },
            { "text": "SULAWESI SELATAN", "value": "4e732ced3463d06de0ca9a15b6153677" },
            { "text": "SULAWESI TENGGARA", "value": "02e74f10e0327ad868d138f2b4fdd6f0" },
            { "text": "SULAWESI TENGAH", "value": "33e75ff09dd601bbe69f351039152189" },
            { "text": "SULAWESI UTARA", "value": "6ea9ab1baa0efb9e19094440c317e21b" },
            { "text": "SULAWESI BARAT", "value": "34173cb38f07f89ddbebc2ac9128303f" },
            { "text": "MALUKU", "value": "c16a5320fa475530d9583c34fd356ef5" },
            { "text": "MALUKU UTARA", "value": "6364d3f0f495b6ab9dcf8d3b5c6e0b01" },
            { "text": "PAPUA", "value": "182be0c5cdcd5072bb1864cdee4d3d6e" },
            { "text": "PAPUA BARAT", "value": "e369853df766fa44e1ed0ff613f563bd" }
        ];

        // Elements
        const modeSelect = document.getElementById('mode');
        const monthSelector = document.getElementById('monthSelector');
        const bulanSelect = document.getElementById('bulan');
        const provSelect = document.getElementById('provinsi');
        const kotaSelect = document.getElementById('kota');
        const searchBtn = document.getElementById('searchBtn');
        const loader = document.getElementById('loader');
        const grid = document.getElementById('scheduleGrid');
        const errBox = document.getElementById('errorMsg');
        const resHeader = document.getElementById('resultsHeader');
        const themeBtn = document.getElementById('themeBtn');
        const pageTitle = document.getElementById('pageTitle');

        // Dark Mode Toggle
        themeBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const icon = themeBtn.querySelector('i');
            if (document.body.classList.contains('dark-mode')) {
                icon.classList.remove('fa-moon');
                icon.classList.add('fa-sun');
            } else {
                icon.classList.remove('fa-sun');
                icon.classList.add('fa-moon');
            }
        });

        // Initialize Provinces and Auto Detect Location
        async function initProvinces() {
            provSelect.innerHTML = '<option value="" disabled selected>Pilih Provinsi...</option>';
            PROVINCES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.value;
                opt.textContent = p.text;
                // Preselect DKI Jakarta as fallback
                if (p.text === "DKI JAKARTA") opt.selected = true;
                provSelect.appendChild(opt);
            });

            // preselect month
            const currentMonth = new Date().getMonth() + 1;
            bulanSelect.value = currentMonth;

            kotaSelect.innerHTML = '<option value="" disabled selected>Mendeteksi lokasi...</option>';
            kotaSelect.disabled = true;
            searchBtn.disabled = true;

            await autoDetectLocation();
        }

        async function autoDetectLocation() {
            hideError();

            try {
                // Determine user loc using BigDataCloud free API or IPAPI
                let locData = null;

                const getByIP = async () => {
                    const res = await fetch('https://ipapi.co/json/');
                    return await res.json();
                };

                // Helper to normalize strings for comparison
                const normalize = (str) => {
                    if (!str) return "";
                    return str.toLowerCase()
                        .replace(/dki /g, '')
                        .replace(/d.i. /g, '')
                        .replace(/kepulauan /g, 'kep. ')
                        .replace(/kota administrasi /g, 'kota ')
                        .replace(/kabupaten /g, 'kab. ')
                        .replace(/ /g, '')
                        .replace(/[^a-z0-9]/g, '');
                };

                // Geolocation first, IP fallback
                let lat, lon;
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 3000 });
                    });
                    lat = position.coords.latitude;
                    lon = position.coords.longitude;

                    const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=id`);
                    locData = await res.json();
                } catch (geoErr) {
                    console.log("Geolocation timeout/denied, using IP fallback.");
                    locData = await getByIP();
                }

                if (!locData) throw new Error("Gagal mendapatkan lokasi");

                const detectedProv = locData.principalSubdivision || locData.region || "";
                const detectedCity = locData.city || locData.locality || "";

                if (!detectedProv && !detectedCity) throw new Error("Lokasi tidak dikenali");

                // 1. Matched Province
                let bestProv = null;
                const normDetectedProv = normalize(detectedProv);

                for (let p of PROVINCES) {
                    const normP = normalize(p.text);
                    if (normDetectedProv.includes(normP) || normP.includes(normDetectedProv)) {
                        bestProv = p;
                        break;
                    }
                }

                if (!bestProv && detectedCity === 'Jakarta') {
                    bestProv = PROVINCES.find(p => p.text === "DKI JAKARTA");
                }

                if (!bestProv) throw new Error(`Provinsi ${detectedProv} tidak ditemukan di database.`);

                // Set Province Dropdown
                provSelect.value = bestProv.value;

                // 2. Fetch Cities for this Province
                const resCities = await fetch(`/api/imsakiyah?action=getCities&prov=${bestProv.value}`);
                const dataCities = await resCities.json();

                if (dataCities.success && dataCities.data.length > 0) {
                    kotaSelect.innerHTML = '';
                    let bestCity = null;
                    const normDetectedCity = normalize(detectedCity);

                    dataCities.data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.value;
                        opt.textContent = c.text;
                        kotaSelect.appendChild(opt);

                        if (normalize(c.text).includes(normDetectedCity) || normDetectedCity.includes(normalize(c.text))) {
                            bestCity = c.value;
                        }
                    });

                    if (bestCity) {
                        kotaSelect.value = bestCity;
                    } else if (dataCities.data.length > 0) {
                        kotaSelect.value = dataCities.data[0].value;
                    }

                    kotaSelect.disabled = false;
                    searchBtn.disabled = false;

                    // Trigger search automatically based on detected location
                    searchBtn.click();
                } else {
                    throw new Error("Gagal memuat kota untuk provinsi terdeteksi.");
                }

            } catch (e) {
                console.error("Auto detect failed: ", e);
                // Fallback to loading DKI jakarta if detection fails entirely
                showError("Gagal mendeteksi lokasi otomatis. Anda dapat mengatur lokasi manual.");
                await loadCities(provSelect.value);
            }
        }

        // Mode Change
        modeSelect.addEventListener('change', (e) => {
            const mode = e.target.value;
            if (mode === 'shalat') {
                monthSelector.style.display = 'block';
                pageTitle.textContent = 'Jadwal Shalat Bulanan';
            } else {
                monthSelector.style.display = 'none';
                pageTitle.textContent = 'Jadwal Imsakiyah Ramadan';
            }
            // Auto Select current month if shown
            const currentMonth = new Date().getMonth() + 1;
            bulanSelect.value = currentMonth;
        });

        // Initialize Provinces
        function initProvinces() {
            provSelect.innerHTML = '<option value="" disabled selected>Pilih Provinsi...</option>';
            PROVINCES.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.value;
                opt.textContent = p.text;
                // Preselect DKI Jakarta
                if (p.text === "DKI JAKARTA") opt.selected = true;
                provSelect.appendChild(opt);
            });

            // preselect month
            const currentMonth = new Date().getMonth() + 1;
            bulanSelect.value = currentMonth;

            loadCities(provSelect.value); // Fetch for default selected
        }

        // Fetch Cities via API (bypass CORS)
        async function loadCities(provValue) {
            kotaSelect.innerHTML = '<option value="" disabled selected>Memuat text...</option>';
            kotaSelect.disabled = true;
            searchBtn.disabled = true;

            try {
                const res = await fetch(`/api/imsakiyah?action=getCities&prov=${provValue}`);
                const data = await res.json();

                kotaSelect.innerHTML = '';
                if (data.success && data.data.length > 0) {
                    data.data.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.value;
                        opt.textContent = c.text;
                        kotaSelect.appendChild(opt);
                    });
                    kotaSelect.disabled = false;
                    searchBtn.disabled = false;
                } else {
                    kotaSelect.innerHTML = '<option value="" disabled selected>Gagal memuat kota</option>';
                    showError("Tidak dapat memuat data Kabupaten/Kota.");
                }
            } catch (e) {
                console.error(e);
                kotaSelect.innerHTML = '<option value="" disabled selected>Error jaringan</option>';
                showError("Gagal terhubung ke server saat memuat kota.");
            }
        }

        // On Province Change
        provSelect.addEventListener('change', (e) => {
            loadCities(e.target.value);
        });

        // Search Form Submit
        searchBtn.addEventListener('click', async () => {
            if (!provSelect.value || !kotaSelect.value) return;

            hideError();
            grid.style.display = 'none';
            resHeader.style.display = 'none';
            loader.style.display = 'flex';
            searchBtn.disabled = true;

            const provText = provSelect.options[provSelect.selectedIndex].text;
            const kotaText = kotaSelect.options[kotaSelect.selectedIndex].text;
            const year = new Date().getFullYear();
            const mode = modeSelect.value;
            const month = bulanSelect.value;
            const monthText = bulanSelect.options[bulanSelect.selectedIndex].text;

            try {
                let url = `/api/imsakiyah?action=getImsakiyah&prov=${provSelect.value}&kota=${kotaSelect.value}&tahun=${year}`;
                if (mode === 'shalat') {
                    url = `/api/imsakiyah?action=getShalat&prov=${provSelect.value}&kota=${kotaSelect.value}&tahun=${year}&bulan=${month}`;
                }

                const res = await fetch(url);
                const result = await res.json();

                if (result.success && result.data && result.data.length > 0) {
                    renderSchedule(result.data, provText, kotaText, year, monthText, result.type, result.hijriah);
                } else {
                    showError(result.message || "Gagal mendapatkan jadwal dari server pusat.");
                }
            } catch (err) {
                console.error(err);
                showError("Terjadi kesalahan jaringan atau server api bermasalah.");
            } finally {
                loader.style.display = 'none';
                searchBtn.disabled = false;
            }
        });

        function renderSchedule(jadwalList, provName, kotaName, tahunM, bulanM, type, tahunH) {
            document.getElementById('lokasiPrint').textContent = `${kotaName}`;

            if (type === 'imsakiyah') {
                document.getElementById('tahunPrint').textContent = `Ramadan ${tahunH || ''} H / ${tahunM} M \u2022 ${provName}`;
            } else {
                document.getElementById('tahunPrint').textContent = `Bulan ${bulanM} ${tahunM} \u2022 ${provName}`;
            }

            grid.innerHTML = '';

            jadwalList.forEach((j, index) => {
                const card = document.createElement('div');
                const today = new Date();

                let isToday = false;

                if (type === 'shalat') {
                    // Cek berdasarkan tanggal masehi untuk jadwal shalat
                    const masehiDateStr = j.tanggal; // e.g. "2026-02-01"
                    const dateParts = masehiDateStr.split('-');
                    // Pastikan tahun, bulan, dan tanggal sama (dengan leading zero)
                    if (dateParts.length === 3) {
                        const y = parseInt(dateParts[0]);
                        const m = parseInt(dateParts[1]);
                        const d = parseInt(dateParts[2]);

                        if (y === today.getFullYear() && m === (today.getMonth() + 1) && d === today.getDate()) {
                            isToday = true;
                        }
                    }
                } else {
                    // Untuk Imsakiyah, Bimas Islam hanya memberikan tanggal 1 s/d 30 tanpa referensi Masehi pasti per baris
                    // Sehingga kita tidak menandai "Hari Ini" secara statis pada indeks 0 lagi agar tidak salah
                    // Biarkan user melihat jadwal full 30 hari
                    // Note: jika punya data konversi bisa ditambahkan di sini.
                }

                card.className = `day-card ${isToday ? 'today' : ''}`;
                card.style.animationDelay = `${index * 0.05}s`;

                const dayStr = type === 'imsakiyah' ? `Ramadan ${j.tanggal}` : j.tanggal;

                card.innerHTML = `
                    <div class="card-header">
                        <div class="date-number">
                            <i class="fas fa-calendar-day" style="opacity: 0.7; font-size: 0.9em;"></i>
                            ${dayStr}
                        </div>
                        ${isToday ? '<span class="badge-today">Hari Ini</span>' : ''}
                    </div>
                    <div class="times-grid">
                        <div class="time-slot highlight">
                            <div class="time-icon"><i class="fas fa-moon"></i></div>
                            <div class="time-info">
                                <span class="time-label">Imsak</span>
                                <span class="time-value">${j.imsak}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-mosque"></i></div>
                            <div class="time-info">
                                <span class="time-label">Subuh</span>
                                <span class="time-value">${j.subuh}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-cloud-sun"></i></div>
                            <div class="time-info">
                                <span class="time-label">Terbit</span>
                                <span class="time-value">${j.terbit}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-sun"></i></div>
                            <div class="time-info">
                                <span class="time-label">Dhuha</span>
                                <span class="time-value">${j.dhuha}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-clock"></i></div>
                            <div class="time-info">
                                <span class="time-label">Zuhur</span>
                                <span class="time-value">${j.dzuhur}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-solid fa-person-praying"></i></div>
                            <div class="time-info">
                                <span class="time-label">Asar</span>
                                <span class="time-value">${j.ashar}</span>
                            </div>
                        </div>
                        <div class="time-slot highlight">
                            <div class="time-icon"><i class="fas fa-sunset"></i><i class="fas fa-cloud-sun-rain"></i></div>
                            <div class="time-info">
                                <span class="time-label" style="color: var(--secondary)">Magrib / Buka</span>
                                <span class="time-value">${j.maghrib}</span>
                            </div>
                        </div>
                        <div class="time-slot">
                            <div class="time-icon"><i class="fas fa-star-and-crescent"></i></div>
                            <div class="time-info">
                                <span class="time-label">Isya'</span>
                                <span class="time-value">${j.isya}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });

            resHeader.style.display = 'block';
            grid.style.display = 'grid';
        }

        function showError(msg) {
            errBox.textContent = msg;
            errBox.style.display = 'block';
        }
        function hideError() {
            errBox.style.display = 'none';
        }

        // Run Init
        window.addEventListener('DOMContentLoaded', initProvinces);
    </script>

    <!-- Histats.com  START  (aync)-->
    <script type="text/javascript">var _Hasync = _Hasync || [];
        _Hasync.push(['Histats.start', '1,5005480,4,0,0,0,00010000']);
        _Hasync.push(['Histats.fasi', '1']);
        _Hasync.push(['Histats.track_hits', '']);
        (function () {
            var hs = document.createElement('script'); hs.type = 'text/javascript'; hs.async = true;
            hs.src = ('//s10.histats.com/js15_as.js');
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(hs);
        })();</script>
    <noscript><a href="/" target="_blank"><img src="//sstatic1.histats.com/0.gif?5005480&101" alt=""
                border="0"></a></noscript>
    <!-- Histats.com  END  -->
</body>

</html>